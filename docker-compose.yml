services:
  # Redis cache
  redis:
    image: redis:7-alpine
    container_name: ember-feed-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Next.js application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dashboard-dev
    ports:
      - "3002:3000"
    volumes:
      # Mount source code for hot reload
      - .:/app
      # Exclude node_modules (use container's version)
      - /app/node_modules
      # Persist Next.js cache for faster rebuilds
      - ./.next:/app/.next
    environment:
      - NODE_ENV=development
      # Enable hot reload polling for Windows/Mac
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
      # Redis connection
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Aggregator service
      - AGGREGATOR_URL=http://aggregator:8000
    stdin_open: true  # Keep container running for interactive debugging
    tty: true
    restart: unless-stopped
    command: npm run dev
    depends_on:
      redis:
        condition: service_healthy

  # Trending Topics Aggregator Service (Python FastAPI)
  aggregator:
    build:
      context: ./aggregator-service
      dockerfile: Dockerfile
    container_name: aggregator-service
    ports:
      - "8000:8000"
    volumes:
      # Mount source code for development
      - ./aggregator-service/app:/app/app
      # Share database file with main app
      - ./prisma/data:/app/data
    environment:
      - DATABASE_URL=sqlite:///app/data/dashboard.db
      - REDIS_URL=redis://redis:6379
      - REDDIT_CLIENT_ID=${REDDIT_CLIENT_ID:-}
      - REDDIT_CLIENT_SECRET=${REDDIT_CLIENT_SECRET:-}
      - NEWS_API_KEY=${NEWS_API_KEY:-}
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy

  # RSSHub - Generate RSS feeds for sources without native RSS
  rsshub:
    image: diygod/rsshub:latest
    container_name: rsshub
    ports:
      - "1200:1200"
    environment:
      - NODE_ENV=production
      - CACHE_TYPE=redis
      - REDIS_URL=redis://redis:6379
      - CACHE_EXPIRE=300
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy

volumes:
  redis_data:
