services:
  # PostgreSQL database
  postgres:
    image: postgres:16-alpine
    container_name: ember-feed-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ember
      POSTGRES_PASSWORD: ember_dev
      POSTGRES_DB: ember_feed
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Init scripts run on first startup (creates n8n database)
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ember -d ember_feed"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis cache
  redis:
    image: redis:7-alpine
    container_name: ember-feed-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Next.js application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dashboard-dev
    ports:
      - "3002:3000"
    volumes:
      # Mount source code for hot reload
      - .:/app
      # Anonymous volume for node_modules (platform-specific binaries rebuilt each time)
      - /app/node_modules
      # Anonymous volume for .next (don't use host's Windows-compiled cache)
      - /app/.next
    environment:
      - NODE_ENV=development
      # Database connection (PostgreSQL)
      - DATABASE_URL=postgresql://ember:ember_dev@postgres:5432/ember_feed
      # Enable hot reload polling for Windows/Mac
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
      # Redis connection
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Aggregator service
      - AGGREGATOR_URL=http://aggregator:8000
      # n8n Integration
      - N8N_API_KEY=${N8N_API_KEY:-}
      # Test mode - enables /api/test/* endpoints for database cleanup
      - TEST_MODE=true
    stdin_open: true  # Keep container running for interactive debugging
    tty: true
    restart: unless-stopped
    command: sh -c "npx prisma db push && npm run dev"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # Trending Topics Aggregator Service (Python FastAPI)
  aggregator:
    build:
      context: ./aggregator-service
      dockerfile: Dockerfile
    container_name: aggregator-service
    ports:
      - "8000:8000"
    volumes:
      # Mount source code for development
      - ./aggregator-service/app:/app/app
    environment:
      - DATABASE_URL=postgresql://ember:ember_dev@postgres:5432/ember_feed
      - REDIS_URL=redis://redis:6379
      - REDDIT_CLIENT_ID=${REDDIT_CLIENT_ID:-}
      - REDDIT_CLIENT_SECRET=${REDDIT_CLIENT_SECRET:-}
      - NEWS_API_KEY=${NEWS_API_KEY:-}
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # RSSHub - Generate RSS feeds for sources without native RSS
  rsshub:
    image: diygod/rsshub:latest
    container_name: rsshub
    ports:
      - "1200:1200"
    environment:
      - NODE_ENV=production
      - CACHE_TYPE=redis
      - REDIS_URL=redis://redis:6379
      - CACHE_EXPIRE=300
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy

  # n8n Workflow Automation - Data collection layer
  n8n:
    image: n8nio/n8n:latest
    container_name: ember-feed-n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      # Basic auth for web UI
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=ember
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD:-ember_n8n_dev}
      # Host configuration
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=${TZ:-America/New_York}
      # PostgreSQL backend (uses separate n8n database)
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=ember
      - DB_POSTGRESDB_PASSWORD=ember_dev
      # Ember Feed integration
      - EMBER_API_URL=http://app:3000
      - EMBER_N8N_API_KEY=${N8N_API_KEY:-}
      - RSSHUB_URL=http://rsshub:1200
      # Apify (optional, for complex scraping)
      - APIFY_API_TOKEN=${APIFY_API_TOKEN:-}
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

volumes:
  postgres_data:
  redis_data:
  n8n_data:
