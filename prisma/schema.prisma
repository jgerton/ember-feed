// Prisma schema for Ember Feed

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Todo model for task management
model Todo {
  id        String   @id @default(cuid())
  text      String
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("todos")
  @@index([completed]) // For filtering active/completed todos
  @@index([completed, createdAt]) // Composite index for querying incomplete todos by date
}

// Article model for news feed
model Article {
  id          String   @id @default(cuid())
  title       String
  description String
  url         String   @unique
  source      String
  score       Int      @default(0)
  publishedAt DateTime
  createdAt   DateTime @default(now())

  // Relations
  activities    UserActivity[]
  topics        ArticleTopic[]
  savedArticles SavedArticle[]
  thoughts      Thought[]

  @@map("articles")
  @@index([publishedAt])
  @@index([score])
  @@index([score, publishedAt]) // Composite index for feed loading
  @@index([source]) // For source filtering
  @@index([publishedAt, source]) // Covering index for recent articles by source
  @@index([publishedAt, score, source]) // Covering index for personalized feed queries
}

// User activity tracking for AI-tailored feed algorithm
model UserActivity {
  id               String   @id @default(cuid())
  articleId        String
  action           String   // "read", "upvote", "downvote", "save", "view"
  timestamp        DateTime @default(now())

  // Reading behavior analytics
  durationSeconds  Int?     // Time spent on article in seconds
  scrollPercentage Int?     // Scroll completion percentage (0-100)

  // Relations
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@map("user_activities")
  @@index([articleId])
  @@index([timestamp])
  @@index([action]) // For filtering by upvote, save, read actions
  @@index([articleId, timestamp]) // Composite index for analytics queries
  @@index([action, timestamp]) // For finding recent upvotes/saves
  @@index([action, timestamp, articleId]) // Covering index for action-filtered queries with article data
}

// Daily log entries for discoveries, blockers, accomplishments
model LogEntry {
  id        String   @id @default(cuid())
  type      String   // "discovery", "blocker", "accomplishment", "thought"
  content   String
  tags      String?  // JSON array of tags
  createdAt DateTime @default(now())

  @@map("log_entries")
  @@index([type])
  @@index([createdAt])
  @@index([type, createdAt]) // Composite index for filtered log queries
}

// Unified Feed model - combines RSS health tracking with source categorization
// Used by both Next.js (article sync) and Python aggregator (trending topics)
model Feed {
  id                  String   @id @default(cuid())
  name                String   // "Hacker News", "The Pragmatic Engineer", etc.
  url                 String   @unique

  // Type & categorization (for Python aggregator)
  type                String   @default("rss")  // "rss", "reddit", "hackernews", "substack", "medium", "api"
  category            String   @default("tech") // "tech", "business", "science", "developer", "startup"

  // Health monitoring (from RssFeed)
  status              String   @default("active") // "active", "failing", "quarantined"
  consecutiveFailures Int      @default(0)
  lastSuccessAt       DateTime?
  lastFailureAt       DateTime?
  lastErrorMessage    String?

  // Scheduling & control
  priority            Int      @default(50)  // 0-100, higher = more important
  updateFrequency     Int      @default(60)  // minutes between checks
  enabled             Boolean  @default(true)
  lastFetched         DateTime?

  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  userSubscriptions   UserFeedSubscription[]
  n8nErrors           N8nError[]

  @@map("feeds")
  @@index([status])
  @@index([enabled])
  @@index([type])
  @@index([category])
  @@index([enabled, status]) // For active feed queries
}

// Topic model for categorization and filtering
model Topic {
  id        String   @id @default(cuid())
  name      String   @unique  // "AI", "Web Development", "Security"
  slug      String   @unique  // "ai", "web-development", "security"
  createdAt DateTime @default(now())

  // Relations
  articles  ArticleTopic[]

  @@map("topics")
  @@index([slug])
}

// Many-to-many relationship between Articles and Topics
model ArticleTopic {
  id         String   @id @default(cuid())
  articleId  String
  topicId    String
  relevance  Float    @default(1.0) // 0.0 - 1.0, how relevant the topic is to the article
  createdAt  DateTime @default(now())

  // Relations
  article    Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  topic      Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([articleId, topicId]) // Prevent duplicate topic assignments
  @@map("article_topics")
  @@index([articleId])
  @@index([topicId])
  @@index([topicId, relevance]) // For finding top articles per topic
  @@index([articleId, relevance]) // Covering index for article topics ordered by relevance
  @@index([articleId, topicId, relevance]) // Covering index for full article-topic queries
}

// Saved articles for "Read Later" queue
model SavedArticle {
  id         String   @id @default(cuid())
  articleId  String   @unique // One article can only be saved once
  priority   Int      @default(3) // 1-5, where 5 is highest priority
  isRead     Boolean  @default(false) // Mark as read/unread
  notes      String?  // Optional user notes about the article
  savedAt    DateTime @default(now())
  readAt     DateTime? // When article was marked as read

  // Relations
  article    Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@map("saved_articles")
  @@index([articleId])
  @@index([priority, savedAt]) // For priority-based sorting
  @@index([isRead])
  @@index([isRead, priority, savedAt]) // Composite index for read later queue queries
}

// User settings for personalization preferences
model UserSettings {
  id              String   @id @default(cuid())
  diversityLevel  String   @default("medium") // "low", "medium", "high"

  // NewsAPI Configuration
  newsApiEnabled    Boolean @default(true)
  newsApiCategories String  @default("technology,science,business") // comma-separated list
  newsApiLanguage   String  @default("en")  // ISO 639-1 language code
  newsApiCountry    String  @default("us")  // ISO 3166-1 alpha-2 country code

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("user_settings")
}

// Thought capture for quick ideas and insights
model Thought {
  id             String   @id @default(cuid())
  text           String   // The actual thought/idea content
  category       String?  // Optional category tag (e.g., "App Ideas", "Random", "Research")
  categoryFields Json?    // Optional category-specific fields (e.g., URL, timestamp for Video Insights)
  articleId      String?  // Optional reference to article that inspired the thought
  userId         String   @default("default-user") // For future multi-user support
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  article   Article? @relation(fields: [articleId], references: [id], onDelete: SetNull)

  @@map("thoughts")
  @@index([createdAt]) // For chronological sorting
  @@index([category]) // For filtering by category
  @@index([articleId]) // For finding thoughts related to an article
  @@index([category, createdAt]) // Composite index for category-filtered queries
}

// User feed subscriptions for personalized trending
model UserFeedSubscription {
  id        String   @id @default(cuid())
  userId    String   @default("default-user") // For future multi-user support
  feedId    String
  createdAt DateTime @default(now())

  // Relations
  feed      Feed @relation(fields: [feedId], references: [id], onDelete: Cascade)

  @@unique([userId, feedId]) // One subscription per user per feed
  @@map("user_feed_subscriptions")
  @@index([userId])
  @@index([feedId])
}

// Hot topics - what's popular RIGHT NOW
model HotTopic {
  id          String   @id @default(cuid())
  keyword     String   // The trending keyword/topic
  timeframe   String   // "24hr", "3day", "7day"
  rank        Int      // 1-5 for top 5
  score       Float    // Hacker News algorithm score
  mentions    Int      // Total mentions across sources
  summary     String   // Why it's hot - aggregated from articles
  sources     String   // JSON array: ["HackerNews", "Reddit", "Medium"]
  sampleUrls  String   // JSON array of top 3 article objects: [{title, url, source}]
  fetchedAt   DateTime // When this trending data was calculated
  createdAt   DateTime @default(now())

  @@unique([keyword, timeframe, fetchedAt]) // Prevent duplicates per fetch
  @@map("hot_topics")
  @@index([timeframe, rank, fetchedAt]) // For querying top 5 by timeframe
  @@index([fetchedAt]) // For time-based queries
  @@index([keyword, timeframe]) // For topic history
}

// Trending up topics - what's GAINING MOMENTUM
model TrendingUpTopic {
  id             String   @id @default(cuid())
  keyword        String   // The trending keyword/topic
  timeframe      String   // "7day", "14day", "30day"
  rank           Int      // 1-5 for top 5
  velocity       Float    // Growth rate/velocity score
  currentVolume  Int      // Mentions in current period
  previousVolume Int      // Mentions in previous period
  percentGrowth  Float    // Percentage increase
  summary        String   // Why it's trending up
  sources        String   // JSON array: ["HackerNews", "Reddit", "Medium"]
  sampleUrls     String   // JSON array of top 3 article objects
  fetchedAt      DateTime // When this trending data was calculated
  createdAt      DateTime @default(now())

  @@unique([keyword, timeframe, fetchedAt]) // Prevent duplicates per fetch
  @@map("trending_up_topics")
  @@index([timeframe, rank, fetchedAt]) // For querying top 5 by timeframe
  @@index([fetchedAt]) // For time-based queries
  @@index([keyword, timeframe]) // For topic history
}

// Historical keyword tracking for velocity calculation
model KeywordHistory {
  id        String   @id @default(cuid())
  keyword   String   // The keyword being tracked
  mentions  Int      // Number of mentions on this date
  sources   String   // JSON array of sources that mentioned it
  date      DateTime @default(now()) // Date of this snapshot
  createdAt DateTime @default(now())

  @@map("keyword_history")
  @@index([keyword, date]) // For time-series queries per keyword
  @@index([date]) // For daily aggregations
  @@index([keyword]) // For keyword lookups
}

// n8n Workflow Error Tracking
// Stores errors reported by n8n workflows for System Health monitoring
model N8nError {
  id           String    @id @default(cuid())
  workflowId   String    // n8n workflow ID
  workflowName String    // Human-readable workflow name
  executionId  String    // n8n execution ID for linking to n8n UI
  nodeId       String?   // Which node failed (optional)
  nodeName     String?   // Human-readable node name (optional)
  errorType    String    // "timeout", "api_error", "parse_error", "rate_limit", etc.
  errorMessage String    // Full error message
  feedId       String?   // Related feed if applicable
  context      String?   // JSON: additional context data
  resolved     Boolean   @default(false)
  resolvedAt   DateTime?
  createdAt    DateTime  @default(now())

  // Relations
  feed         Feed?     @relation(fields: [feedId], references: [id], onDelete: SetNull)

  @@map("n8n_errors")
  @@index([createdAt])
  @@index([resolved])
  @@index([workflowName])
  @@index([feedId])
  @@index([resolved, createdAt]) // For unresolved errors query
}
